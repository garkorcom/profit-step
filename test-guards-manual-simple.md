# üß™ –ü—Ä–æ—Å—Ç–æ–π –ú–∞–Ω—É–∞–ª—å–Ω—ã–π –¢–µ—Å—Ç V2 Guards

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 3-5 –º–∏–Ω—É—Ç
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: Firebase Console –¥–æ—Å—Ç—É–ø

---

## ‚úÖ –®–ê–ì 1: –û—Ç–∫—Ä–æ–π—Ç–µ Firestore Console

```bash
open "https://console.firebase.google.com/project/profit-step/firestore/data/users"
```

---

## ‚úÖ –®–ê–ì 2: –°–æ–∑–¥–∞–π—Ç–µ –¢–µ—Å—Ç–æ–≤–æ–≥–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í Firestore Console:**

1. –ù–∞–∂–º–∏—Ç–µ **"Start collection"** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é `users`
2. –ù–∞–∂–º–∏—Ç–µ **"Add document"**
3. **Document ID**: `test-guards-manual`
4. **–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—è**:

```
email: "test-guards@example.com" (string)
displayName: "Test Guards User" (string)
lastSeen: (timestamp) [–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è]
loginCount: 0 (number)
status: "active" (string)
companyId: "test-company-123" (string)
createdAt: (timestamp) [–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è]
```

5. –ù–∞–∂–º–∏—Ç–µ **"Save"**

---

## ‚úÖ –®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç–µ lastSeen (Trigger Function)

**–ü–æ–¥–æ–∂–¥–∏—Ç–µ 2 —Å–µ–∫—É–Ω–¥—ã**, –∑–∞—Ç–µ–º:

1. –í —Ç–æ–º –∂–µ –¥–æ–∫—É–º–µ–Ω—Ç–µ `test-guards-manual`
2. –ù–∞–∂–º–∏—Ç–µ **"Edit"** (–∫–∞—Ä–∞–Ω–¥–∞—à)
3. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ `lastSeen`
4. –ò–∑–º–µ–Ω–∏—Ç–µ timestamp –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —á–∞—Å—ã —Å–ø—Ä–∞–≤–∞)
5. –ù–∞–∂–º–∏—Ç–µ **"Update"**

**–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å `incrementLoginCount_v2`!**

---

## ‚úÖ –®–ê–ì 4: –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 –°–µ–∫—É–Ω–¥

–û–∂–∏–¥–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Cloud Function...

```
‚è≥ 10 —Å–µ–∫—É–Ω–¥...
```

---

## ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 5.1 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ loginCount

**–í Firestore Console:**
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
2. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç `test-guards-manual`
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**

```
‚úÖ loginCount: 1 (–±—ã–ª–æ 0)
‚úÖ lastModifiedBy: "incrementLoginCount_v2"
‚úÖ lastModifiedAt: (recent timestamp)
```

**–ï—Å–ª–∏ loginCount = 1 ‚Üí Guards —Ä–∞–±–æ—Ç–∞—é—Ç! üéâ**

---

### 5.2 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ processedEvents

**–í Firestore Console:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é `processedEvents`
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
3. **–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:**

```
eventId: (random string)
functionName: "incrementLoginCount_v2"
timestamp: (recent timestamp)
```

**–ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –µ—Å—Ç—å ‚Üí EventId tracking —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ**

---

## ‚úÖ –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –õ–æ–≥–∏

–û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
firebase functions:log --only incrementLoginCount_v2 | grep "Guard\|‚úÖ\|‚è©" | head -20
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Field Guard: lastSeen changed (xxx ‚Üí yyy)
‚úÖ Full Guard: All checks passed for incrementLoginCount_v2
‚úÖ incrementLoginCount_v2: Login count incremented for user test-guards-manual
```

---

## ‚úÖ –®–ê–ì 7: –¢–µ—Å—Ç EventId Guard (–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ EventId Guard –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã:**

1. –°–Ω–æ–≤–∞ –æ–±–Ω–æ–≤–∏—Ç–µ `lastSeen` –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ `test-guards-manual`
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫—É–Ω–¥
3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ loginCount:**
- –ï—Å–ª–∏ `loginCount = 1` ‚Üí EventId Guard —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä—ã)
- –ï—Å–ª–∏ `loginCount = 2` ‚Üí –ù–æ—Ä–º–∞–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ eventId)

---

## ‚úÖ –®–ê–ì 8: Cleanup

**–£–¥–∞–ª–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

1. –í Firestore Console ‚Üí `users` ‚Üí `test-guards-manual`
2. –ù–∞–∂–º–∏—Ç–µ **"Delete document"**
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –¢–µ—Å—Ç

- [x] loginCount —É–≤–µ–ª–∏—á–∏–ª—Å—è —Å 0 –¥–æ 1
- [x] lastModifiedBy = "incrementLoginCount_v2"
- [x] processedEvents —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- [x] –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å Guard messages (‚è© –∏–ª–∏ ‚úÖ)

### ‚ùå –ï—Å–ª–∏ –¢–µ—Å—Ç –ù–µ –ü—Ä–æ—à—ë–ª

**–ü—Ä–æ–±–ª–µ–º–∞ 1: loginCount –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –§—É–Ω–∫—Ü–∏—è –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë 10 —Å–µ–∫)
2. –§—É–Ω–∫—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore rules)
3. Guard –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
firebase functions:log --only incrementLoginCount_v2 | head -50

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ñ—É–Ω–∫—Ü–∏–∏
firebase functions:list | grep incrementLoginCount_v2
```

---

**–ü—Ä–æ–±–ª–µ–º–∞ 2: processedEvents –ø—É—Å—Ç–∞—è**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. EventId Guard –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è (–±–∞–≥)
2. Firestore rules –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø–∏—Å—å
3. –§—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore rules
cat firestore.rules

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# match /processedEvents/{eventId} {
#   allow read, write: if request.auth != null;
# }
```

---

**–ü—Ä–æ–±–ª–µ–º–∞ 3: –õ–æ–≥–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç Guard messages**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. V2 —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è V1)
2. –õ–æ–≥–∏ –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã
firebase functions:list

# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å incrementLoginCount_v2, –Ω–µ incrementLoginCount
```

---

## üéâ –¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù!

–ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ V2 Guards —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ EventId tracking –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç infinite loops –≤–∫–ª—é—á–µ–Ω–∞
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—é–¥–∂–µ—Ç $10/–¥–µ–Ω—å –∏ –º–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ 24-48 —á–∞—Å–æ–≤.

---

**–°–æ–∑–¥–∞–Ω–æ**: 2025-11-06
**–°—Ç–∞—Ç—É—Å**: üß™ **MANUAL TEST READY**
