rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // Проверка аутентификации
    function isSignedIn() {
      return request.auth != null;
    }

    // Проверка владения ресурсом
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ==================== USER PROFILES ====================

    // Пользователи могут читать и обновлять ТОЛЬКО свой профиль
    // Создание и удаление выполняется ТОЛЬКО через Cloud Functions
    match /users/{userId} {
      // --- Вспомогательные функции для управления командой ---
      function getUserProfile(uid) {
        return get(/databases/$(database)/documents/users/$(uid)).data;
      }

      function requestingUserRole() {
        return getUserProfile(request.auth.uid).role;
      }

      function requestingUserCompanyId() {
        return getUserProfile(request.auth.uid).companyId;
      }

      function isOwnProfile() {
        return request.auth.uid == userId;
      }

      function targetUserCompanyId() {
        return resource.data.companyId;
      }

      function targetUserIsActive() {
        return resource.data.status == 'active';
      }

      // ЧТЕНИЕ:
      // Разрешено, если:
      // 1. Это мой профиль, ИЛИ
      // 2. Я из той же компании (для просмотра коллег)
      allow read: if isSignedIn() &&
                   (request.auth.uid == userId ||
                    requestingUserCompanyId() == targetUserCompanyId());

      // СОЗДАНИЕ:
      // Запрещено на клиенте. Только через Cloud Function 'onUserCreate'.
      allow create: if false;

      // ОБНОВЛЕНИЕ:
      // Сложное правило с двумя сценариями:
      allow update: if
        // Сценарий 1: Я обновляю свой собственный профиль
        (isOwnProfile() &&
            // ...но не могу менять себе роль, статус или компанию
            !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status', 'companyId']))
        ||
        // Сценарий 2: Я Админ компании
        (requestingUserRole() == 'admin' &&
            requestingUserCompanyId() == targetUserCompanyId() &&
            // ...но не могу понизить роль самому себе
            !(isOwnProfile() && request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])));

      // УДАЛЕНИЕ:
      // Запрещено на клиенте. Только через Cloud Function 'adminDeleteUser'.
      allow delete: if false;
    }

    // ==================== USER DATA COLLECTIONS ====================

    // Проверка активности пользователя
    function userIsActive(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.status == 'active';
    }

    // Сметы пользователя (Estimates)
    match /users/{userId}/estimates/{estimateId} {
      allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);
    }

    // Проекты пользователя (Projects)
    match /users/{userId}/projects/{projectId} {
      allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);

      // Документы проекта
      match /documents/{documentId} {
        allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);
      }
    }

    // Контрагенты пользователя (Counterparties)
    match /users/{userId}/counterparties/{counterpartyId} {
      allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);
    }

    // Задачи пользователя (Tasks)
    match /users/{userId}/tasks/{taskId} {
      allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);
    }

    // Товары/Инвентарь пользователя (Products)
    match /users/{userId}/products/{productId} {
      allow read, write: if isOwner(userId) && userIsActive(request.auth.uid);
    }

    // ==================== PUBLIC DATA ====================

    // Публичные сметы (для просмотра по ссылке)
    // Любой может читать, запись запрещена
    match /publicEstimates/{estimateId} {
      allow read: if true;
      allow write: if false;
    }

    // ==================== DASHBOARD COLLECTIONS ====================

    // Helper functions для дашбордов
    function isSuperAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    function getUserCompany() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // System-level collections (Super Admin only)
    match /systemErrors/{errorId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Cloud Functions
    }

    match /emailEvents/{eventId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Cloud Functions
    }

    match /costReports/{reportId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Cloud Functions
    }

    match /growthMetrics/{metricId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Cloud Functions
    }

    match /engagementMetrics/{metricId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Cloud Functions
    }

    // Company-scoped collections
    match /invitations/{inviteId} {
      // Чтение: только пользователи из той же компании
      allow read: if isSignedIn() &&
                     resource.data.companyId == getUserCompany();
      // Создание: только админы компании
      allow create: if isSignedIn() &&
                      request.resource.data.companyId == getUserCompany() &&
                      isAdmin();
      // Обновление/Удаление: только админы компании
      allow update, delete: if isSignedIn() &&
                              resource.data.companyId == getUserCompany() &&
                              isAdmin();
    }

    match /activityLog/{activityId} {
      // Чтение: только пользователи из той же компании
      allow read: if isSignedIn() &&
                     resource.data.companyId == getUserCompany();
      // Запись: только через Cloud Functions
      allow write: if false;
    }

    match /userActivation/{userId} {
      // Чтение: сам пользователь или superadmin
      allow read: if isSignedIn() &&
                     (request.auth.uid == userId || isSuperAdmin());
      // Запись: только через Cloud Functions
      allow write: if false;
    }

    match /featureUsage/{usageId} {
      // Чтение: все аутентифицированные пользователи
      allow read: if isSignedIn();
      // Создание: пользователи могут отслеживать свое использование
      allow create: if isSignedIn();
      // Обновление: только Cloud Functions
      allow update, delete: if false;
    }

    match /notifications/{notificationId} {
      // Чтение: только для получателя уведомления
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Обновление: пользователь может отметить как прочитанное
      allow update: if isSignedIn() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      // Создание/Удаление: только через Cloud Functions
      allow create, delete: if false;
    }

    // Companies collection
    match /companies/{companyId} {
      // Чтение: только пользователи из этой компании
      allow read: if isSignedIn() && getUserCompany() == companyId;
      // Запись: только через Cloud Functions
      allow write: if false;
    }

    // ==================== DEFAULT DENY ====================

    // Запретить доступ ко всем остальным документам
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

/**
 * ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE
 *
 * Эти правила обеспечивают:
 * 1. Пользователи могут работать ТОЛЬКО со своими данными
 * 2. Профили создаются/удаляются только через Cloud Functions
 * 3. Публичные сметы доступны для чтения всем
 * 4. Все остальное по умолчанию запрещено
 *
 * РАЗВЕРТЫВАНИЕ:
 * firebase deploy --only firestore:rules
 */
